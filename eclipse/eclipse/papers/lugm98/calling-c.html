<HTML>
<HEAD>
<TITLE>Lisp/C Integration in Eclipse: Calling C</TITLE>
<meta name="description" content="Calling C from Lisp">
<meta name="keywords" content="lisp, call, C, declaration, data">  
<meta name="date" content="9/1/97">
<meta name="author" content="Howard Stearns">
<meta name="copyright" content="Elwood Corp.">
</HEAD>

<BODY bgcolor="#FFFFFF">

<A HREF="lisp-c.html">[Paper Contents]</A> 
<A HREF="calling-lisp.html">[Previous]</A> 
<A HREF="conclusion.html">[Next]</A> 
<A HREF="http://www.elwood.com/eclipse-info">[Eclipse Home Page]</A>

<HR>


<a name="lisp-calls-c"><h2>4: Using C from Lisp</h2></a>

The following code can be used in any ANSI Common Lisp implementation
to declare <code>MY-FUNCTION</code> to be a function of two arguments (a <code>FIXNUM</code> and
a <code>BASE-CHAR</code>) that returns a <code>DOUBLE-FLOAT</code>:

<pre>
   (DECLAIM (FTYPE (FUNCTION (FIXNUM BASE-CHAR)
			     DOUBLE-FLOAT) 
		   MY-FUNCTION))
</pre>

<p> 
The C code produced by Eclipse <code>COMPILE-FILE</code> for a call such as <code>(SETQ X
(MY-FUNCTION Y Z))</code> might be something like the following (see <a
href="calling-lisp.html#c-calls-lisp">Section 3</a>):

<pre>
   clObject usrMyFunction(clProto);
   ...
   clSetq(x, usrMyFunction(y, z, clEOA));
</pre>

<p>
ANSI defines the <code>FTYPE</code> declaration only for the <code>CL:FUNCTION</code> list-form
type-specifier. Eclipse defines <code>FTYPE</code> for two other list-form
type-specifiers as well: <code>C:FUNCTION</code> and <code>C:MACRO</code>. Here is some Lisp
code that uses this:

<pre>
   ...
   (DECLAIM (FTYPE (C:FUNCTION (C:INT C:CHAR)
			       C:DOUBLE) 
		   FOO C::BAR) 
	    (TYPE C:DOUBLE X) 
	    (TYPE C:INT Y) 
	    (TYPE C:CHAR Z)) 
   ...
   (SETQ X (FOO Y Z))
   ...
   (SETQ X (C::BAR Y Z))
</pre>

<p>
Eclipse <code>COMPILE-FILE</code> then generates C code like this:

<pre>
   double usrFoo __P(int, char), bar __P(int, char);
   ...
   x = usrFoo(y, z);
   ...
   x = bar(y, z);
</pre>

<p>
Note the different C function declaration and assignment, and the lack
of <code>clEOA</code>. Note also that the names of symbols in the C package are not
mangled, but <code>USER::FOO</code> becomes <code>usrFoo()</code>. (See <a
href="core.html#identifiers">Section 2.1</a>).

<p>
This simple extension of the type system by Eclipse provides a more
direct, lower level interface than the more typical wrapper functions
generated by foreign function interfaces. Of course, there is no
reason that a user- or system-provided foreign function interface
abstraction can't be built on top of this.

<p>
As it stands, however, callers of C code in Eclipse currently suffer
the same hardships as callers of C code in any portable C application:

<ul>
<p><li> Functions must be declared before they can be used.

<p><li> Arguments to functions must be of the correct primitive C
type. Neither Eclipse nor the C compiler will automatically convert
data from, say, <code>clObject</code>s that happen to be a
<code>FIXNUM</code>, to <code>int</code>. Instead, programmers must
explicitly use system- or user-supplied conversion functions, that are
themselves declared in Lisp as <code>C:FUNCTION</code>s or
<code>C:MACRO</code>s.

<p><li> Newly compiled C code cannot be dynamically loaded into a running
application. Instead, a new executable must generally be compiled,
linked, and run. (See <a href="calling-lisp.html#load">Section 3.5.2</a>)
</ul>

<p>
Because of this, there is little reason for the Eclipse interpreter
(i.e., <code>EVAL</code>) to accept calls to <code>C:FUNCTION</code>s or <code>C:MACRO</code>s.

<HR>

<A HREF="lisp-c.html">[Paper Contents]</A> 
<A HREF="calling-lisp.html">[Previous]</A> 
<A HREF="conclusion.html">[Next]</A> 
<A HREF="http://www.elwood.com/eclipse-info">[Eclipse Home Page]</A>

</BODY>
</HTML>
